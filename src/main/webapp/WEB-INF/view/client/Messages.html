<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MXH Messages - Tin nhắn</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link th:href="@{/client/css/Profile.css}" rel="stylesheet" />
    <link th:href="@{/client/css/Header.css}" rel="stylesheet" />
    <link th:href="@{/client/css/LeftSidebar.css}" rel="stylesheet" />
    <link th:href="@{/client/css/Messages.css}" rel="stylesheet" />
    <link th:href="@{/client/css/Notifications.css}" rel="stylesheet" />
    <link th:href="@{/client/css/DarkMode.css}" rel="stylesheet" />

    <style>
        /* 1. Nền Tím Gradient toàn màn hình */
        body {
            background: linear-gradient(135deg, #8f94fb 0%, #4e54c8 100%) !important;
            background-attachment: fixed !important;
            height: 100vh;
            overflow: hidden;
            /* Chặn cuộn body, chỉ cuộn nội dung chat */
        }

        /* 2. Sidebar (Menu trái): Chỉnh trong suốt để hòa vào nền */
        .Sidebar-nav {
            background: transparent !important;
            border-right: none !important;
            box-shadow: none !important;
            z-index: 50;
            /* Thấp hơn Header */
        }

        .sidebar-nav-item {
            color: rgba(255, 255, 255, 0.9) !important;
            transition: all 0.2s ease;
        }

        .sidebar-nav-item svg {
            color: currentColor !important;
        }

        .sidebar-nav-item:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            transform: translateX(5px);
        }

        .sidebar-nav-item.active {
            background: white !important;
            color: #4e54c8 !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-weight: bold !important;
        }

        .sidebar-nav-item.active svg {
            color: #4e54c8 !important;
        }

        /* 3. WRAPPER CHÍNH: Đẩy nội dung ra xa Sidebar & Header */
        .messages-wrapper {
            position: fixed;
            top: 60px;
            /* Cách Header một chút */
            left: 290px;
            /* Cách Sidebar trái (280px + 10px khoảng hở) */
            right: 20px;
            /* Cách lề phải */
            bottom: 20px;
            /* Cách lề dưới */
            padding: 0 !important;
            margin: 0 !important;
            /* Không dùng background ở wrapper để thấy nền tím */
            display: flex;
            z-index: 10;
        }

        /* 4. CONTAINER TIN NHẮN: Thiết kế dạng "Thẻ Nổi" (Floating Card) */
        .messages-container {
            width: 100% !important;
            height: 100% !important;
            background: rgba(255, 255, 255, 0.95) !important;
            /* Trắng mờ sang trọng */
            backdrop-filter: blur(10px);
            /* Hiệu ứng kính mờ */
            border-radius: 24px !important;
            /* Bo góc tròn trịa */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            /* Bóng đổ sâu */
            border: 1px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
            /* Bo góc nội dung con */
            display: grid;
            grid-template-columns: 320px 1fr;
            /* Chia cột: Danh sách | Chat */
        }

        /* 5. Cột trái: Danh sách tin nhắn */
        .conversations-panel {
            background: rgba(245, 247, 250, 0.6);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .conversations-header {
            padding: 20px;
            background: transparent;
        }

        .conversations-title {
            font-size: 22px;
            font-weight: 800;
            color: #333;
            letter-spacing: -0.5px;
        }

        /* Search input đẹp hơn */
        .search-input {
            background: white !important;
            border: 1px solid #eee !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: #8f94fb !important;
            box-shadow: 0 4px 10px rgba(143, 148, 251, 0.2);
        }

        /* 6. Cột phải: Khu vực Chat */
        .chat-panel {
            background: white;
        }

        .chat-header {
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #f0f0f0;
        }

        .chat-user-name {
            font-size: 18px;
            font-weight: 700;
        }

        /* Tin nhắn Bubble đẹp hơn */
        .message-bubble {
            padding: 12px 18px;
            border-radius: 18px !important;
            font-size: 15px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #8f94fb 0%, #4e54c8 100%);
            /* Gradient tím */
            color: white;
            border-bottom-right-radius: 4px !important;
        }

        .message.received .message-bubble {
            background: #f0f2f5;
            color: #333;
            border-bottom-left-radius: 4px !important;
        }

        /* Ô nhập liệu */
        .message-input-container {
            padding: 20px;
            background: white;
        }

        .message-input {
            background: #f0f2f5;
            border: none;
            padding: 12px 20px;
        }

        .message-input:focus {
            background: #e4e6eb;
            box-shadow: none;
        }

        .send-btn {
            background: #4e54c8;
            color: white;
            box-shadow: 0 4px 10px rgba(78, 84, 200, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
            background: #3f44a5;
        }

        /* FIX: Khi Sidebar thu nhỏ trên PC */
        body.sidebar-collapsed .messages-wrapper {
            left: 90px;
            /* Thu hẹp khoảng cách trái */
        }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .messages-wrapper {
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 0;
            }

            .messages-container {
                border-radius: 0 !important;
            }
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/Header :: user-header}"></div>

    <div th:replace="~{fragments/Sidebar :: Sidebar}"></div>

    <div class="messages-wrapper">
        <div class="messages-container">

            <div class="conversations-panel">
                <div class="conversations-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="conversations-title">Tin nhắn</h2>
                        <button class="new-message-btn" id="newMessageBtn" title="Soạn tin mới"
                            style="background: #e4e6eb;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="conversations-search" style="padding-top: 0;">
                    <div style="position: relative;">
                        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#999"
                            stroke-width="2" style="position: absolute; left: 12px; top: 10px;">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="searchConversations" placeholder="Tìm kiếm trên Messenger..."
                            class="search-input" style="padding-left: 40px;">
                    </div>
                </div>

                <div class="conversations-list" id="conversationsList">
                </div>
            </div>

            <div class="chat-panel" id="chatPanel">

                <div class="empty-state" id="emptyState">
                    <div
                        style="width: 120px; height: 120px; background: rgba(143, 148, 251, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#4e54c8" stroke-width="1.5">
                            <path
                                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                            </path>
                        </svg>
                    </div>
                    <h3 style="color: #333; font-weight: 700;">Tin nhắn của bạn</h3>
                    <p style="color: #666;">Chọn một người bạn để bắt đầu trò chuyện</p>
                    <button class="btn-primary" id="startNewMessage"
                        style="background: linear-gradient(135deg, #8f94fb 0%, #4e54c8 100%); border: none; padding: 10px 30px; border-radius: 30px; margin-top: 10px;">Gửi
                        tin nhắn mới</button>
                </div>

                <div class="chat-active" id="chatActive" style="display: none;">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <div style="position: relative;">
                                <img src="" alt="Avt" class="chat-avatar" id="chatAvatar"
                                    style="width: 45px; height: 45px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <span class="online-indicator"
                                    style="border: 2px solid white; width: 13px; height: 13px;"></span>
                            </div>
                            <div class="chat-user-details" style="margin-left: 15px;">
                                <h3 class="chat-user-name" id="chatUserName">User Name</h3>
                                <span class="chat-user-status" id="chatUserStatus"
                                    style="color: #46d160; font-weight: 500;">Đang hoạt động</span>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="chat-action-btn" title="Thông tin">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4e54c8"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="messages-area" id="messagesArea" style="background: #fdfdfd;">
                    </div>

                    <div class="message-input-container">
                        <input type="file" id="imageUploadInput" accept="image/*" style="display:none" />

                        <button class="attach-btn" id="attachImageBtn" title="Gửi ảnh">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4e54c8"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </button>

                        <div style="flex: 1; position: relative;">
                            <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." class="message-input"
                                style="width: 100%; border-radius: 25px; padding-right: 40px;">
                            <button class="emoji-btn" id="emojiBtn"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                </svg>
                            </button>
                        </div>

                        <button class="send-btn" id="sendMessageBtn" title="Gửi">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M22 2L11 13"></path>
                                <path d="M22 2l-7 20-4-9-9-4 20-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="new-message-form" id="newMessageForm" style="display: none;">
                    <div class="new-message-header">
                        <h3>Tin nhắn mới</h3>
                        <button class="close-form-btn" id="closeFormBtn">X</button>
                    </div>
                    <div class="recipient-input-container">
                        <label>Đến:</label>
                        <input type="text" id="recipientInput" placeholder="Nhập tên người nhận..."
                            class="recipient-input">
                        <div class="recipient-suggestions" id="recipientSuggestions"></div>
                    </div>
                    <div class="new-message-content">
                        <textarea id="newMessageText" placeholder="Nội dung..." class="new-message-textarea"></textarea>
                        <button class="send-new-message-btn" id="sendNewMessageBtn">Gửi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/client/js/TimeUtils.js}"></script>
    <script th:src="@{/client/js/Header.js}"></script>
    <script th:src="@{/client/js/LeftSidebar.js}"></script>
    <script th:src="@{/client/js/Notifications.js}"></script>
    <script th:src="@{/client/js/Messages.js}"></script>
</body>

</html>