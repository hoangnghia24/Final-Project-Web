<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Ch·ªânh s·ª≠a Avatar - TFT</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/client/css/Profile.css}" rel="stylesheet" />
    <link th:href="@{/client/css/Header.css}" rel="stylesheet" />
    
    <style>
        .edit-avatar-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .avatar-creator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .preview-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .current-avatar {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 4px solid #6200ea;
            background-color: #f0f0f0;
        }

        .controls-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 14px;
            color: #1c1c1c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group select {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-group select:hover {
            border-color: #6200ea;
        }

        .control-group select:focus {
            outline: none;
            border-color: #6200ea;
            box-shadow: 0 0 0 3px rgba(98, 0, 234, 0.1);
        }

        .btn-save {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 20px;
            font-weight: 700;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .btn-save:hover {
            opacity: 0.9;
        }

        .btn-cancel {
            background: white;
            color: #6200ea;
            border: 2px solid #6200ea;
            padding: 12px 30px;
            border-radius: 20px;
            font-weight: 700;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background-color: #f3f0fa;
        }

        .random-btn {
            background: #f3f0fa;
            color: #6200ea;
            border: 2px solid #6200ea;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .random-btn:hover {
            background: #6200ea;
            color: white;
        }

        body.dark-mode .edit-avatar-container {
            background-color: #1e1e1e;
        }

        body.dark-mode .control-group label {
            color: #e0e0e0;
        }

        body.dark-mode .control-group select {
            background-color: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .control-group select:hover {
            border-color: #bb86fc;
        }

        body.dark-mode .random-btn {
            background-color: #2a2a2a;
            color: #bb86fc;
            border-color: #bb86fc;
        }

        body.dark-mode .random-btn:hover {
            background-color: #bb86fc;
            color: #1e1e1e;
        }

        @media (max-width: 768px) {
            .avatar-creator-grid {
                grid-template-columns: 1fr;
            }
            
            .current-avatar {
                width: 200px;
                height: 200px;
            }
        }
    </style>

    <script th:src="@{/client/js/Header.js}"></script>
</head>

<body>

    <!-- Include header fragment -->
    <div th:replace="~{fragments/header :: user-header}"></div>

    <div class="edit-avatar-container">
        <h2 style="text-align: center; margin-bottom: 10px;">T·∫°o Avatar c·ªßa b·∫°n</h2>
        <p style="text-align: center; color: #7c7c7c; margin-bottom: 30px;">T√πy ch·ªânh avatar theo phong c√°ch c·ªßa b·∫°n</p>
        
        <div class="avatar-creator-grid">
            <!-- Preview Section -->
            <div class="preview-section">
                <img id="avatar-preview" class="current-avatar" 
                     src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" 
                     alt="Avatar Preview">
                <button class="random-btn" onclick="randomizeAvatar()">üé≤ Ng·∫´u nhi√™n</button>
            </div>

            <!-- Controls Section -->
            <div class="controls-section">
                <div class="control-group">
                    <label>Ki·ªÉu t√≥c</label>
                    <select id="topType">
                        <option value="NoHair">Kh√¥ng t√≥c</option>
                        <option value="Hat">M≈©</option>
                        <option value="Hijab">Hijab</option>
                        <option value="Turban">KhƒÉn x·∫øp</option>
                        <option value="WinterHat1">M≈© len</option>
                        <option value="LongHairBigHair" selected>T√≥c d√†i</option>
                        <option value="LongHairBob">T√≥c bob</option>
                        <option value="LongHairBun">T√≥c b√∫i</option>
                        <option value="LongHairCurly">T√≥c xoƒÉn</option>
                        <option value="LongHairCurvy">T√≥c g·ª£n s√≥ng</option>
                        <option value="LongHairDreads">T√≥c dreadlock</option>
                        <option value="LongHairFrida">T√≥c Frida</option>
                        <option value="LongHairFro">T√≥c afro</option>
                        <option value="LongHairStraight">T√≥c th·∫≥ng</option>
                        <option value="LongHairStraight2">T√≥c th·∫≥ng 2</option>
                        <option value="ShortHairDreads01">T√≥c ng·∫Øn dreadlock</option>
                        <option value="ShortHairDreads02">T√≥c ng·∫Øn dreadlock 2</option>
                        <option value="ShortHairShortFlat">T√≥c c·∫Øt ng·∫Øn</option>
                        <option value="ShortHairShortRound">T√≥c tr√≤n</option>
                        <option value="ShortHairShortWaved">T√≥c ng·∫Øn g·ª£n s√≥ng</option>
                        <option value="ShortHairSides">T√≥c c·∫°o hai b√™n</option>
                        <option value="ShortHairTheCaesar">T√≥c Caesar</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Ph·ª• ki·ªán</label>
                    <select id="accessoriesType">
                        <option value="Blank" selected>Kh√¥ng</option>
                        <option value="Eyepatch">B·ªãt m·∫Øt</option>
                        <option value="Kurt">Kurt</option>
                        <option value="Prescription01">K√≠nh 1</option>
                        <option value="Prescription02">K√≠nh 2</option>
                        <option value="Round">K√≠nh tr√≤n</option>
                        <option value="Sunglasses">K√≠nh r√¢m</option>
                        <option value="Wayfarers">Wayfarers</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>M√†u t√≥c</label>
                    <select id="hairColor">
                        <option value="Auburn" selected>N√¢u ƒë·ªè</option>
                        <option value="Black">ƒêen</option>
                        <option value="Blonde">V√†ng</option>
                        <option value="BlondeGolden">V√†ng kim</option>
                        <option value="Brown">N√¢u</option>
                        <option value="BrownDark">N√¢u s·∫´m</option>
                        <option value="PastelPink">H·ªìng pastel</option>
                        <option value="Platinum">B·∫°ch kim</option>
                        <option value="Red">ƒê·ªè</option>
                        <option value="SilverGray">X√°m b·∫°c</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>R√¢u</label>
                    <select id="facialHairType">
                        <option value="Blank" selected>Kh√¥ng</option>
                        <option value="BeardMedium">R√¢u trung b√¨nh</option>
                        <option value="BeardLight">R√¢u nh·∫π</option>
                        <option value="BeardMajestic">R√¢u d√†i</option>
                        <option value="MoustacheFancy">Ria m√©p qu√Ω ph√°i</option>
                        <option value="MoustacheMagnum">Ria m√©p Magnum</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Qu·∫ßn √°o</label>
                    <select id="clotheType">
                        <option value="BlazerShirt" selected>√Åo blazer</option>
                        <option value="BlazerSweater">√Åo len blazer</option>
                        <option value="CollarSweater">√Åo c·ªï l·ªç</option>
                        <option value="GraphicShirt">√Åo thun in</option>
                        <option value="Hoodie">√Åo hoodie</option>
                        <option value="Overall">Y·∫øm</option>
                        <option value="ShirtCrewNeck">√Åo c·ªï tr√≤n</option>
                        <option value="ShirtScoopNeck">√Åo c·ªï thuy·ªÅn</option>
                        <option value="ShirtVNeck">√Åo c·ªï V</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>M·∫Øt</label>
                    <select id="eyeType">
                        <option value="Default" selected>M·∫∑c ƒë·ªãnh</option>
                        <option value="Close">Nh·∫Øm m·∫Øt</option>
                        <option value="Cry">Kh√≥c</option>
                        <option value="Dizzy">Ch√≥ng m·∫∑t</option>
                        <option value="EyeRoll">LƒÉn m·∫Øt</option>
                        <option value="Happy">Vui v·∫ª</option>
                        <option value="Hearts">Tr√°i tim</option>
                        <option value="Side">Nh√¨n sang</option>
                        <option value="Squint">Nheo m·∫Øt</option>
                        <option value="Surprised">Ng·∫°c nhi√™n</option>
                        <option value="Wink">Nh√°y m·∫Øt</option>
                        <option value="WinkWacky">Nh√°y m·∫Øt h√†i</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>L√¥ng m√†y</label>
                    <select id="eyebrowType">
                        <option value="Default" selected>M·∫∑c ƒë·ªãnh</option>
                        <option value="DefaultNatural">T·ª± nhi√™n</option>
                        <option value="Angry">Gi·∫≠n d·ªØ</option>
                        <option value="AngryNatural">Gi·∫≠n t·ª± nhi√™n</option>
                        <option value="FlatNatural">Ph·∫≥ng</option>
                        <option value="RaisedExcited">Ph·∫•n kh√≠ch</option>
                        <option value="SadConcerned">Bu·ªìn lo</option>
                        <option value="UnibrowNatural">L√¥ng m√†y n·ªëi</option>
                        <option value="UpDown">L√™n xu·ªëng</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Mi·ªáng</label>
                    <select id="mouthType">
                        <option value="Default" selected>M·∫∑c ƒë·ªãnh</option>
                        <option value="Concerned">Lo l·∫Øng</option>
                        <option value="Disbelief">Kh√¥ng tin</option>
                        <option value="Eating">ƒÇn</option>
                        <option value="Grimace">NhƒÉn m·∫∑t</option>
                        <option value="Sad">Bu·ªìn</option>
                        <option value="ScreamOpen">H√©t l·ªõn</option>
                        <option value="Serious">Nghi√™m t√∫c</option>
                        <option value="Smile">C∆∞·ªùi</option>
                        <option value="Tongue">L√® l∆∞·ª°i</option>
                        <option value="Twinkle">L·∫•p l√°nh</option>
                        <option value="Vomit">N√¥n</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>M√†u da</label>
                    <select id="skinColor">
                        <option value="Tanned" selected>R√°m n·∫Øng</option>
                        <option value="Yellow">V√†ng</option>
                        <option value="Pale">Nh·∫°t</option>
                        <option value="Light">S√°ng</option>
                        <option value="Brown">N√¢u</option>
                        <option value="DarkBrown">N√¢u ƒë·∫≠m</option>
                        <option value="Black">ƒêen</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="btn-save" onclick="saveAvatar()">üíæ L∆∞u Avatar</button>
        <button class="btn-cancel" onclick="window.location.href='/profile'">‚ùå H·ªßy</button>
    </div>

    <script>
        // Avatar creator - Using DiceBear v9 API with correct parameter names
        function updateAvatar() {
            const avatarPreview = document.getElementById('avatar-preview');
            if (!avatarPreview) {
                console.error('Avatar preview not found!');
                return;
            }
            
            // Get all values
            const topType = document.getElementById('topType').value;
            const accessoriesType = document.getElementById('accessoriesType').value;
            const hairColor = document.getElementById('hairColor').value;
            const facialHairType = document.getElementById('facialHairType').value;
            const clotheType = document.getElementById('clotheType').value;
            const eyeType = document.getElementById('eyeType').value;
            const eyebrowType = document.getElementById('eyebrowType').value;
            const mouthType = document.getElementById('mouthType').value;
            const skinColor = document.getElementById('skinColor').value;
            
            // Color mappings - API needs hex colors
            const hairColorMap = {
                'Auburn': '724133',
                'Black': '2c1b18',
                'Blonde': 'd6b370',
                'BlondeGolden': 'f59797',
                'Brown': '4a312c',
                'BrownDark': '2c1b18',
                'PastelPink': 'f59797',
                'Platinum': 'ecdcbf',
                'Red': 'c93305',
                'SilverGray': 'e8e1e1'
            };
            
            const skinColorMap = {
                'Tanned': 'd08b5b',
                'Yellow': 'f8d25c',
                'Pale': 'ffdbb4',
                'Light': 'edb98a',
                'Brown': 'ae5d29',
                'DarkBrown': '614335',
                'Black': '614335'
            };
            
            const params = [];
            
            // Top (hair style) - comprehensive mapping
            const topMap = {
                'Hat': 'hat',
                'Hijab': 'hijab',
                'Turban': 'turban',
                'WinterHat1': 'winterHat1',
                'LongHairBigHair': 'bigHair',
                'LongHairBob': 'bob',
                'LongHairBun': 'bun',
                'LongHairCurly': 'curly',
                'LongHairCurvy': 'curvy',
                'LongHairDreads': 'dreads',
                'LongHairFrida': 'frida',
                'LongHairFro': 'fro',
                'LongHairStraight': 'straight',
                'LongHairStraight2': 'straight02',
                'ShortHairDreads01': 'dreads01',
                'ShortHairDreads02': 'dreads02',
                'ShortHairShortFlat': 'shortFlat',
                'ShortHairShortRound': 'shortRound',
                'ShortHairShortWaved': 'shortWaved',
                'ShortHairSides': 'sides',
                'ShortHairTheCaesar': 'theCaesar'
            };
            
            // Handle special cases
            if (topType === 'NoHair') {
                // For no hair, set probability to 0
                params.push('topProbability=0');
            } else if (topMap[topType]) {
                params.push(`top=${topMap[topType]}`);
            }
            
            // Hair Color - use hex
            if (hairColor && hairColorMap[hairColor]) {
                params.push(`hairColor=${hairColorMap[hairColor]}`);
            }
            
            // Accessories - proper mapping
            if (accessoriesType && accessoriesType !== 'Blank') {
                const accessoriesMap = {
                    'Eyepatch': 'eyepatch',
                    'Kurt': 'kurt',
                    'Prescription01': 'prescription01',
                    'Prescription02': 'prescription02',
                    'Round': 'round',
                    'Sunglasses': 'sunglasses',
                    'Wayfarers': 'wayfarers'
                };
                if (accessoriesMap[accessoriesType]) {
                    params.push(`accessories=${accessoriesMap[accessoriesType]}`);
                    params.push(`accessoriesProbability=100`);
                }
            }
            
            // Facial Hair - proper mapping
            if (facialHairType && facialHairType !== 'Blank') {
                const facialHairMap = {
                    'BeardLight': 'beardLight',
                    'BeardMajestic': 'beardMajestic',
                    'BeardMedium': 'beardMedium',
                    'MoustacheFancy': 'moustacheFancy',
                    'MoustacheMagnum': 'moustacheMagnum'
                };
                if (facialHairMap[facialHairType]) {
                    params.push(`facialHair=${facialHairMap[facialHairType]}`);
                    params.push(`facialHairProbability=100`);
                    // Also add facial hair color
                    if (hairColor && hairColorMap[hairColor]) {
                        params.push(`facialHairColor=${hairColorMap[hairColor]}`);
                    }
                }
            }
            
            // Clothing
            if (clotheType) {
                let clothValue = clotheType;
                if (clothValue === 'BlazerShirt') clothValue = 'blazerAndShirt';
                else if (clothValue === 'BlazerSweater') clothValue = 'blazerAndSweater';
                else if (clothValue === 'CollarSweater') clothValue = 'collarAndSweater';
                else if (clothValue === 'GraphicShirt') clothValue = 'graphicShirt';
                else if (clothValue === 'Hoodie') clothValue = 'hoodie';
                else if (clothValue === 'Overall') clothValue = 'overall';
                else if (clothValue === 'ShirtCrewNeck') clothValue = 'shirtCrewNeck';
                else if (clothValue === 'ShirtScoopNeck') clothValue = 'shirtScoopNeck';
                else if (clothValue === 'ShirtVNeck') clothValue = 'shirtVNeck';
                params.push(`clothing=${clothValue}`);
            }
            
            // Eyes
            let eyeValue = 'default';
            if (eyeType && eyeType !== 'Default') {
                eyeValue = eyeType.charAt(0).toLowerCase() + eyeType.slice(1);
                if (eyeValue === 'close') eyeValue = 'closed';
                if (eyeValue === 'eyeRoll') eyeValue = 'eyeRoll';
                if (eyeValue === 'winkWacky') eyeValue = 'winkWacky';
                if (eyeValue === 'dizzy') eyeValue = 'xDizzy';
            }
            params.push(`eyes=${eyeValue}`);
            
            // Eyebrows
            let ebValue = 'default';
            if (eyebrowType && eyebrowType !== 'Default') {
                ebValue = eyebrowType.charAt(0).toLowerCase() + eyebrowType.slice(1);
            }
            params.push(`eyebrows=${ebValue}`);
            
            // Mouth
            let mouthValue = 'default';
            if (mouthType && mouthType !== 'Default') {
                mouthValue = mouthType.charAt(0).toLowerCase() + mouthType.slice(1);
                if (mouthValue === 'screamOpen') mouthValue = 'screamOpen';
            }
            params.push(`mouth=${mouthValue}`);
            
            // Skin Color - use hex
            if (skinColor && skinColorMap[skinColor]) {
                params.push(`skinColor=${skinColorMap[skinColor]}`);
            }
            
            // Background color
            params.push('backgroundColor=b6e3f4');
            
            // Use v9 API
            const url = `https://api.dicebear.com/9.x/avataaars/svg?${params.join('&')}`;
            
            console.log('=== UPDATING AVATAR ===');
            console.log('URL:', url);
            
            // Direct assignment with cache buster
            avatarPreview.src = url + '&t=' + Date.now();
            
            avatarPreview.onload = function() {
                console.log('‚úì Avatar loaded successfully!');
            };
            
            avatarPreview.onerror = function(e) {
                console.error('‚úó Failed to load avatar');
                console.error('Error:', e);
                console.error('URL:', url);
            };
        }
        
        function randomizeAvatar() {
            console.log('üé≤ Randomizing...');
            const selects = ['topType', 'accessoriesType', 'hairColor', 'facialHairType', 
                           'clotheType', 'eyeType', 'eyebrowType', 'mouthType', 'skinColor'];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select && select.options.length > 0) {
                    const randomIndex = Math.floor(Math.random() * select.options.length);
                    select.selectedIndex = randomIndex;
                }
            });
            
            updateAvatar();
        }
        
        function saveAvatar() {
            const avatarImg = document.getElementById('avatar-preview');
            if (!avatarImg || !avatarImg.src) {
                alert('Vui l√≤ng ch·ªçn avatar tr∆∞·ªõc!');
                return;
            }
            
            // L·∫•y username t·ª´ localStorage (ƒë√£ ƒë∆∞·ª£c l∆∞u khi login)
            const username = localStorage.getItem('username');
            
            if (!username) {
                alert('‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.');
                window.location.href = '/login';
                return;
            }
            
            console.log('Saving avatar for user:', username);
            console.log('Avatar URL:', avatarImg.src);
            
            // L∆∞u v√†o localStorage
            localStorage.setItem('userAvatarUrl', avatarImg.src);
            
            // G·ª≠i v·ªÅ server ƒë·ªÉ l∆∞u v√†o database
            $.ajax({
                url: '/update-avatar',
                type: 'POST',
                data: {
                    username: username,
                    avatarUrl: avatarImg.src
                },
                success: function(response) {
                    console.log('Server response:', response);
                    if (response.success) {
                        alert('‚úì ' + response.message);
                        
                        // C·∫≠p nh·∫≠t avatar tr√™n header ngay l·∫≠p t·ª©c
                        const headerAvatar = document.getElementById('header-user-avatar');
                        if (headerAvatar) {
                            const avatarInHeader = headerAvatar.querySelector('img');
                            if (avatarInHeader) {
                                avatarInHeader.src = avatarImg.src;
                            }
                        }
                        
                        // Chuy·ªÉn v·ªÅ trang profile
                        setTimeout(function() {
                            window.location.href = '/profile';
                        }, 500);
                    } else {
                        alert('‚úó ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error saving avatar:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi l∆∞u avatar! Vui l√≤ng th·ª≠ l·∫°i.');
                }
            });
        }
        
        // Setup on load
        window.onload = function() {
            console.log('=== AVATAR CREATOR READY ===');
            
            const selects = document.querySelectorAll('.control-group select');
            console.log('Found ' + selects.length + ' select elements');
            
            selects.forEach(function(select) {
                select.addEventListener('change', function() {
                    console.log('Changed: ' + this.id + ' ‚Üí ' + this.value);
                    updateAvatar();
                });
            });
            
            console.log('Generating initial avatar...');
            updateAvatar();
        };
    </script>

</body>

</html>
